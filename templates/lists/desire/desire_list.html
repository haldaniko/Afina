{% extends "base.html" %}
{% load custom_filters %}
{% load static %}

{% block title %} Tables {% endblock %}

{% block content %}

  <div class="py-3">
    <div class="d-flex justify-content-between w-100 flex-wrap">
      <div class="mb-3 mb-lg-0">
        <h1 class="h4">Desire list</h1>
      </div>
      <div>
        <a href="{% url 'lists:desire-create' %}" class="btn btn-primary link-to-page">
          Create
        </a>
      </div>
    </div>
  </div>

  {% include "includes/search_form.html" %}

  <div class="card border-0 shadow mb-4">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-centered table-nowrap mb-0 rounded">
          <thead class="thead-light">
          <tr>
            <th class="border-0 rounded-start">Name</th>
            <th class="border-0">Description</th>
            <th class="border-0">Price</th>
            <th class="border-0 rounded-end">Link</th>
          </tr>
          </thead>
          <tbody>
          {% for desire in desire_list %}
            <tr>

              <td>
                <div class="d-flex align-items-center">
                  <button class="status-btn border-0 bg-transparent" data-id="{{ desire.id }}"
                          data-status="{{ desire.status }}">
                    {% if desire.status %}
                      <span class="circle filled"></span>
                    {% else %}
                      <span class="circle"></span>
                    {% endif %}
                  </button>
                  <span
                      data-url="{% url 'lists:desire-detail' desire.id %}"
                      class="open-modal ml-2">
                        {{ desire.name }}
                  </span>
                </div>
              </td>

              <td class="open-modal" data-url="{% url 'lists:desire-detail' desire.id %}">
                {{ desire.description|truncate_words }}
              </td>

              <td class="open-modal" data-url="{% url 'lists:desire-detail' desire.id %}">
                {% if desire.price %}
                  {{ desire.price }} â‚¬
                {% else %}
                  â€”â€”
                {% endif %}
              </td>

              <td>
                {% if desire.link %}
                  <a target="_blank" href="{{ desire.link }}">ðŸ”—</a>
                {% else %}
                  â€”â€”
                {% endif %}
              </td>

            </tr>
          {% endfor %}

          <div id="modal" class="modal" style="display: none;">
            <div class="modal-content">
              <span class="close-modal">&times;</span>
              <div id="modal-body"></div>
            </div>
          </div>

          </tbody>
        </table>
      </div>
    </div>
  </div>

{% endblock content %}

{% block javascripts %}
  <script>
      function getCsrfToken() {
          const csrfToken = document.cookie.split(';').find(cookie => cookie.trim().startsWith('csrftoken='));
          return csrfToken ? csrfToken.split('=')[1] : '';
      }

      document.addEventListener("DOMContentLoaded", function () {
          const buttons = document.querySelectorAll('.status-btn');

          buttons.forEach(button => {
              button.addEventListener('click', function () {
                  const circle = this.querySelector('.circle');
                  const status = this.dataset.status === 'true';
                  const desireId = this.dataset.id;

                  if (status) {
                      circle.classList.remove('filled');
                      this.dataset.status = 'false';
                  } else {
                      circle.classList.add('filled');
                      this.dataset.status = 'true';
                  }

                  const updateStatusUrl = `${desireId}/update-status/`;

                  fetch(updateStatusUrl, {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                          'X-CSRFToken': getCsrfToken()
                      },
                      body: JSON.stringify({
                          status: this.dataset.status
                      })
                  })
                      .then(response => response.json())
                      .then(data => {
                          if (data.success) {
                              console.log('Status updated successfully');
                          } else {
                              console.error('Error updating status');
                          }
                      })
                      .catch(error => {
                          console.error('Error:', error);
                      });
              });
          });
      });
  </script>

  <script>
      document.addEventListener('DOMContentLoaded', function () {
          document.querySelectorAll('.open-modal').forEach(button => {
              button.addEventListener('click', function () {
                  const url = this.getAttribute('data-url');
                  fetch(url)
                      .then(response => response.text())
                      .then(html => {
                          document.getElementById('modal-body').innerHTML = html;
                          document.getElementById('modal').style.display = 'flex';
                      })
                      .catch(error => console.error('Error:', error));
              });
          });

          document.querySelector('.close-modal').addEventListener('click', function () {
              document.getElementById('modal').style.display = 'none';
          });

          document.getElementById('modal').addEventListener('click', function (event) {
              if (event.target === this) {
                  this.style.display = 'none';
              }
          });
      });
  </script>
{% endblock %}


