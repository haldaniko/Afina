{% extends "base.html" %}
{% load custom_filters %}
{% load static %}

{% block title %} Tables {% endblock %}

{% block content %}

  <div class="py-3">
    <div class="d-flex justify-content-between w-100 flex-wrap">
      <div class="mb-3 mb-lg-0">
        <h1 class="h4">Desire list</h1>
      </div>
      <div>
        <a href="{% url 'lists:desire-create' %}" class="btn btn-primary link-to-page">
          Create
        </a>
      </div>
    </div>
  </div>

  {% include "includes/search_form.html" %}

  <div class="card border-0 shadow mb-4">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-centered table-nowrap mb-0 rounded">
          <thead class="thead-light">
          <tr>
            <th class="border-0 rounded-start">Name</th>
            <th class="border-0">Description</th>
            <th class="border-0">Price</th>
            <th class="border-0 rounded-end">Link</th>
          </tr>
          </thead>
          <tbody>
          {% for desire in desire_list %}
            <tr>
              <td>
                <div class="d-flex align-items-center">
                  <button
                      class="status-btn border-0 bg-transparent"
                      data-id="{{ desire.id }}"
                      data-status="{{ desire.status }}"
                  >
                    {% if desire.status %}
                      <span class="circle filled"></span>
                    {% else %}
                      <span class="circle"></span>
                    {% endif %}
                  </button>
                  <a href="{% url 'lists:desire-detail' desire.id %}" class="ml-2">{{ desire.name }}</a>
                </div>
              </td>
              <td>
                <a href="{% url 'lists:desire-detail' desire.id %}">{{ desire.description|truncate_words }}</a>
              </td>
              <td>
                {% if desire.price %}
                  <a href="{% url 'lists:desire-detail' desire.id %}">{{ desire.price }} â‚¬</a>
                {% else %}
                  <a href="{% url 'lists:desire-detail' desire.id %}">â€”â€”</a>
                {% endif %}
              </td>
              <td>
                {% if desire.link %}
                  <a target="_blank" href="{{ desire.link }}">ðŸ”—</a>
                {% else %}
                  <a href="#">â€”â€”</a>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
  <script>
      function getCsrfToken() {
          const csrfToken = document.cookie.split(';').find(cookie => cookie.trim().startsWith('csrftoken='));
          return csrfToken ? csrfToken.split('=')[1] : '';
      }

      document.addEventListener("DOMContentLoaded", function () {
          const buttons = document.querySelectorAll('.status-btn');

          buttons.forEach(button => {
              button.addEventListener('click', function () {
                  const circle = this.querySelector('.circle');
                  const status = this.dataset.status === 'true';
                  const desireId = this.dataset.id;

                  if (status) {
                      circle.classList.remove('filled');
                      this.dataset.status = 'false';
                  } else {
                      circle.classList.add('filled');
                      this.dataset.status = 'true';
                  }

                  const updateStatusUrl = `${desireId}/update-status/`;

                  fetch(updateStatusUrl, {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                          'X-CSRFToken': getCsrfToken()
                      },
                      body: JSON.stringify({
                          status: this.dataset.status
                      })
                  })
                      .then(response => response.json())
                      .then(data => {
                          if (data.success) {
                              console.log('Status updated successfully');
                          } else {
                              console.error('Error updating status');
                          }
                      })
                      .catch(error => {
                          console.error('Error:', error);
                      });
              });
          });
      });
  </script>
{% endblock %}


